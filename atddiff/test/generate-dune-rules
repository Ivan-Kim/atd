#! /usr/bin/env bash
#
# Generate a dune file for our test files using glob patterns.
# See https://discuss.ocaml.org/t/creating-generic-rules-in-dune/7757/5
#
set -eu

test_names=$(for x in *_old.atd; do echo $(basename "$x" _old.atd); done)

cat > dune <<EOF
; Generated by $0
; For adding tests, read the instructions in the Makefile.
EOF
for name in $test_names; do
  cat >> dune <<EOF
(rule
 (targets $name.txt)
 (deps ${name}_old.atd ${name}_new.atd)
 (action (run %{bin:atddiff} %{deps} -o %{targets})))

(rule
 (alias runtest)
 (deps $name.txt)
 (action (diff $name.expected.txt $name.txt)))

EOF

  # Create empty output files if they don't exist already so as to save
  # some manual labor
  if ! [[ -e "$name".expected.txt ]]; then
    touch "$name".expected.txt
  fi
done
